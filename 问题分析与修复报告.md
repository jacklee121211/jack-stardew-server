# 容器无限重启循环问题分析与修复报告

## 问题概述

根据日志文件（`clash/1`）分析，发现了以下关键问题：

1. **容器无限重启循环**：从682行开始，容器不断重复执行 `Step 1: Setting up environment...` 和 `Step 2: Checking Steam credentials...`
2. **AutoLoadGame mod 问题**：646行显示 `[Auto Load Game] Attempted to load a save that doesn't seem to exist.`
3. **VNC 密码处理问题**：399行显示 VNC 密码超过8个字符的警告

## 根本原因分析

### 1. 脚本语法错误（已修复）

**问题**：`entrypoint.sh` 脚本第576行有一个多余的 `fi` 语句，没有任何对应的 `if` 语句。

**影响**：虽然可能不会直接导致语法错误（因为bash可能忽略），但这是一个结构性问题，可能导致脚本执行异常。

**修复**：已删除多余的 `fi` 语句。

### 2. AutoLoadGame Mod 配置问题（已修复）

**问题**：
- AutoLoadGame mod 的配置文件 `config.json` 中 `LastFileLoaded` 字段为空字符串 `""` 或指向不存在的存档文件
- 日志显示：`[Auto Load Game] Attempted to load a save that doesn't seem to exist.`
- 这导致游戏在启动时尝试加载不存在的存档，可能触发游戏崩溃
- 游戏崩溃后，容器被 docker `restart: unless-stopped` 策略重启，导致无限循环

**为什么原版 Puppy-Stardew 不会有这个问题**：
- 原版项目可能没有包含 AutoLoadGame mod
- 或者原版的 AutoLoadGame 配置处理更好
- 或者原版在首次运行时正确创建了存档，所以 AutoLoadGame 有有效的存档路径

**修复**：
1. 在脚本中添加了 AutoLoadGame 配置检查和修复逻辑
2. 在启动服务器前，检查 `LastFileLoaded` 指向的存档是否存在
3. 如果存档不存在，自动清空 `LastFileLoaded` 字段，防止 mod 尝试加载不存在的存档
4. 在服务器崩溃后，添加额外的检查和警告，提示用户检查 AutoLoadGame 配置

### 3. VNC 密码处理优化（已优化）

**问题**：
- VNC 密码超过8个字符时会触发警告并被截断
- x11vnc 的密码文件创建方式可能不够规范

**修复**：
1. 改进了 VNC 密码验证逻辑
2. 使用 `x11vnc -storepasswd` 正确创建密码文件
3. 添加了密码为空的检查和默认值处理

### 4. 游戏崩溃处理优化（已优化）

**问题**：
- 当游戏崩溃时，由于脚本开头设置了 `set -e`，可能导致脚本在某些情况下意外退出
- 脚本退出后，docker 的 `restart: unless-stopped` 策略会重启容器，导致无限循环

**修复**：
1. 在运行游戏服务器时，临时禁用 `set -e`（使用 `set +e`）
2. 捕获游戏的退出代码，确保脚本继续执行而不是退出
3. 添加了更完善的错误处理和日志输出

## 修复内容总结

### 1. 删除多余的 `fi` 语句

```bash
# 第576行的多余 fi 已删除
```

### 2. 添加 AutoLoadGame 配置检查和修复

```bash
# 在修复 Mods 目录权限后，添加了 AutoLoadGame 配置检查
if [ -f "/home/steam/stardewvalley/Mods/AutoLoadGame/config.json" ]; then
    LAST_FILE=$(grep -o '"LastFileLoaded": *"[^"]*"' /home/steam/stardewvalley/Mods/AutoLoadGame/config.json | cut -d'"' -f4)
    if [ -n "$LAST_FILE" ]; then
        SAVE_PATH="/home/steam/.config/StardewValley/Saves/$LAST_FILE"
        if [ ! -d "$SAVE_PATH" ]; then
            log_warn "AutoLoadGame: Save file '$LAST_FILE' not found. Clearing LastFileLoaded to prevent crash."
            sed -i 's/"LastFileLoaded": *"[^"]*"/"LastFileLoaded": ""/g' /home/steam/stardewvalley/Mods/AutoLoadGame/config.json
        fi
    fi
fi
```

### 3. 改进 VNC 密码处理

```bash
# 使用 x11vnc -storepasswd 正确创建密码文件
x11vnc -storepasswd "$VNC_PASSWORD" "$VNC_PASSWD_FILE" 2>/dev/null || {
    # 备用方案
    echo -n "$VNC_PASSWORD" > "$VNC_PASSWD_FILE"
    chmod 600 "$VNC_PASSWD_FILE"
}
```

### 4. 改进游戏崩溃处理

```bash
# 临时禁用 exit on error，确保脚本继续执行
set +e
./StardewModdingAPI --server
EXIT_CODE=$?
set -e
```

## 与原版 Puppy-Stardew 的对比

### 原版可能没有的问题：

1. **原版可能没有 AutoLoadGame mod**：
   - 这是本项目添加的额外功能
   - 如果首次运行没有创建存档，AutoLoadGame 会尝试加载不存在的存档，导致崩溃

2. **原版的启动流程可能不同**：
   - 原版可能要求用户首次必须通过 VNC 创建存档
   - 或者原版的 AutoLoadGame 配置默认是禁用的

3. **原版的错误处理可能更完善**：
   - 原版可能在游戏崩溃时有更好的处理逻辑
   - 或者原版没有设置 `restart: unless-stopped` 策略

## 建议的后续操作

1. **首次部署时**：
   - 确保通过 VNC 连接并创建存档
   - 或者暂时禁用 AutoLoadGame mod，直到创建第一个存档后再启用

2. **如果问题仍然存在**：
   - 检查 `data/game/Mods/AutoLoadGame/config.json` 文件
   - 手动清空 `LastFileLoaded` 字段：`"LastFileLoaded": ""`
   - 或者临时重命名 AutoLoadGame mod 目录以禁用它

3. **长期解决方案**：
   - 考虑在首次运行时自动禁用 AutoLoadGame，直到检测到存档存在
   - 或者在 AutoLoadGame 配置中添加存档存在性检查

## 修复文件

- `docker/scripts/entrypoint.sh` - 已修复所有问题

## 测试建议

1. 删除现有容器和数据（如果可能）
2. 使用修复后的脚本重新构建镜像
3. 启动容器并观察是否还会出现无限重启循环
4. 如果 AutoLoadGame 仍然有问题，检查日志中的警告信息

